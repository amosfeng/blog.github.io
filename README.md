#Welcome to Amos Blog

Load Balancing vSphere Clusters with DRS
最近，一位客户报告说，DRS无法负载均衡集群。在正常情况下，轻微的不平衡是无关紧要的。这是因为DRS的主要目的不是在每个主机之间完美平衡负载。相反，DRS会监视资源需求，并确保每个虚拟机都能获得资源。当DRS确定VM存在更好的主机时，它会建议移动该VM。
然而，一些客户仍然希望在集群内的所有主机上均匀分配利用率。本文旨在提供实现此目标的建议，同时考虑到在大多数情况下，这将导致额外的vMotion活动。
###迁移阈值
# 该阈值是基于CPU和内存负载可以接受多少集群不平衡的度量。滑块用于选择从最保守（1）到最积极（5）的五个设置之一。滑块越向右移动，更积极的DRS将用于平衡群集。

使用群集的负载不平衡度量计算每个迁移推荐的优先级。此度量标准在vSphere Web Client的集群“摘要”选项卡中显示为“当前主机负载标准偏差”。

集群不平衡的集群将导致更高优先级迁移建议
## 有关此度量的更多信息以及如何计算推荐优先级，请参阅VMware知识库文章“ 计算VMware DRS迁移建议的优先级 ”。

当迁移阈值设置为更积极的设置时，目标主机负载偏差值会降低。迁移阈值越高，目标范围越小。只要当前负载标准偏差小于或等于目标主机负载值，DRS将考虑集群平衡。

如果您正在从vSphere Web Client查看CPU和MEM利用率，并得出结论，您的群集不是您想要的平衡，请检查启用DRS的群集中的迁移阈值设置，以确保其未设置为太保守 简单地将此滑块移动到更积极的阈值将降低目标标准偏差值，并导致DRS执行更多迁移以实现更好的负载平衡。

将此值设置为优先级4（第二个到最右边的设置）为那些希望在没有执行太多迁移的情况下进行集群平衡的人提供了一个很好的平衡。设置优先级5将提供最均衡的负载平衡，但会导致频繁的vMotions，可能不会为虚拟机提供任何性能优势。
### 您是否曾在vSphere Web Client中查看MEM的主机利用率，并想知道为什么主机似乎不平衡，而DRS则表示平衡？那是有原因的。vSphere Web Client显示已消耗的内存，而DRS在计算当前主机负载时使用活动内存。这种差异在VM内存大部分空闲的环境中尤其常见，但VM一度耗尽了大部分的分配。消耗的内存度量是虚拟机在其生命周期的任何时间使用的最大内存量，即使VM实际上并没有使用大部分内存。相比之下，活动内存是VM当前正在使用的内存量的估计; 估计使用每5分钟运行一次的内存采样算法。

消耗的内存量度不是衡量DRS有效性的最准确方法。要获得当前主机负载的更好的指示，需要查看每个主机的活动内存计数器，以确定主机负载是否相互平衡。具体来说，DRS使用（活动内存）+（25％的空闲内存）来确定当前主机负载的值。

从vSphere 5.5开始，引入了称为PercentIdleMBInMemDemand的高级设置，可用于更改此行为。增加此值将导致DRS在进行DRS计算时使用更多的消耗的内存值。这通常会导致生成更高优先级的建议。优先级越高，DRS将更可能将VM移动到另一个主机，以实现更好的集群平衡。

为有效值PercentIdleMBInMemDemand可以是从0到100 0将导致DRS仅使用有源存储器的所有计算，和100将导致DRS仅使用消耗的内存。在最近的实验室测试中，设置PercentIdleMBInMemDemand = 50表现出非常积极的结果。更改此值会增加更高优先级建议的数量，默认迁移阈值（3）将采取措施来移动虚拟机。由于DRS正在使用更接近消耗的内存度量的值，所以vSphere Web Client中表示的集群负载更平衡。

将PercentIdleMBInMemDemand设置为100也可以完成，这将导致DRS使用消耗的内存。这与vSphere Web Client显示的值相同。但是，只有在内存不超过提交的环境中才应设置为100，否则可能会出现意外的结果。

突发CPU工作负载
积极的CPUActive是vSphere 5.5中首次引入的另一个设置。此设置旨在提高CPU处于非常活跃状态的环境中的CPU负载平衡。DRS通常会在过去5分钟内使用平均值进行CPU需求计算。当激进的CPUActive高级设置被启用时，DRS将从使用平均值切换到第80个百分位数（即间隔中的第二个最高值）。这将有助于一些DRS不会根据CPU需求提出移动虚拟机的建议，因为过去5分钟内的平均需求远远低于生成该建议所需的平均需求。
以下是此高级设置的一个示例。超过5分钟的时间，VM使用50％，70％，10％，5％和5％。这个虚拟机在本质上是非常spikey，其中VM只需要很长时间的CPU，然后移动到更多的空闲状态。平均5分钟利用率为28％，这可能不够高，不足以建议将VM移动到另一个主机。然而，当启用AggressiveCPUActive设置时，DRS将使用50％这是第80个百分位数。

建议
总而言之，实现主机的均匀负载平衡不是DRS的主要目的。但是，它可以配置为以额外的vMotion迁移为代价来实现此结果。
迁移阈值= 4 | 这是获得更好的负载平衡的第一步。这将导致优先级4的建议迁移到其他主机，以获得更高的负载平衡水平。 PercentIdleMBInMemDemand = 50 | 这将指示DRS在为主机负载生成计算时确定空闲内存的两倍。这将使用更接近于vSphere Web Client中显示的值的值，并导致生成更高优先级的建议。上述两种设置的组合将会产生更多的建议。这将导致主机的平衡。 AggressiveCPUActive = 1 | 当在CPU尖锐的环境中使用，否则可能会丢失。如果您在虚拟机中看到更多的准备时间，并且DRS未生成建议，则此设置可以提高这些类型工作负载的DRS有效性。 如果您选择不更改DRS的任何默认设置，那么您可以放心，DRS仍然在幕后工作，以确保所有VM都获得了他们所拥有的资源。

关于作者
Amos是一名高级技术营销架构师，致力于软件定义数据中心技术，专门从事VMware vSphere云平台产品和服务。他以前的经验包括在VMware的云基础架构和管理专业服务组织中担任架构师，他在VMware的财富100客户项目中进行了磋商。Amos拥有许多行业认证，包括VMware认证专家（VCP＃69），Nutanix超融合认证专家（NPP #70）。

Support or Contact
amosfeng@hotmail.com
